64Data.length / 1024), "KB");
                
                const payload = {
                    sessionId: sessionId,
                    resumeData: base64Data,
                    resumeFileName: resumeFile.name,
                    resumeMimeType: resumeFile.type,
                    resumeFileSize: resumeFile.size,
                    jobDescription: jobDescription || "",
                    candidateEmail: candidateEmail,
                    interviewType: selectedInterviewType
                };
                
                console.log("üì§ Sending payload to AI interviewer...");
                console.log("üéØ Interview type:", selectedInterviewType);
                showTypingIndicator();
                
                const response = await fetch(UPLOAD_URL, {
                    method: 'POST',
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                console.log("üì• Response status:", response.status);
                hideTypingIndicator();

                if (!response.ok) {
                    const errorText = await response.text();
                    console.log("‚ùå Upload failed:", errorText);
                    throw new Error(`Upload failed: ${response.status} - ${errorText}`);
                }
                
                const responseText = await response.text();
                console.log("üìã Raw response:", responseText.substring(0, 200) + "...");
                
                if (!responseText || responseText.trim() === '') {
                    throw new Error('Empty response from AI interviewer');
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.log("‚ùå JSON parse error:", parseError.message);
                    throw new Error('Invalid JSON response from AI interviewer');
                }

                console.log("‚úÖ Interview setup successful");

                setupInterviewUI(data);

            } catch (error) {
                hideTypingIndicator();
                console.log("‚ùå Error:", error.message);
                console.error('Error starting interview:', error);
                
                addMessage(`<strong>‚ùå Error starting interview:</strong><br>${error.message}<br><br>Please try again.`, false);
                
                buttons.forEach(btn => {
                    btn.disabled = false;
                });
            }
        }

        function goBackToCategories() {
            stopTimer();
            
            interviewStarted = false;
            
            const chatMessagesDiv = document.getElementById('chatMessages');
            const messages = chatMessagesDiv.querySelectorAll('.message');
            messages.forEach(msg => msg.remove());

            const mcqOptions = chatMessagesDiv.querySelectorAll('.mcq-options');
            mcqOptions.forEach(opt => opt.remove());
            
            const intro = document.querySelector('.interview-intro');
            if (!intro) {
                const newIntro = document.createElement('div');
                newIntro.className = 'interview-intro';
                newIntro.innerHTML = `
                    <h3><strong>Practice today, conquer tomorrow.</strong></h3>
                    <p>Upload your resume and job description, then choose the type of interview practice you need.<br>You can end any interview by typing "END" or when the timer ends.</p>
                `;
                chatMessagesDiv.insertBefore(newIntro, chatMessagesDiv.firstChild);
            }
            
            document.getElementById('chatInput').style.display = 'none';
            document.getElementById('categorySelection').style.display = 'block';
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('timer').style.display = 'none';
            
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(btn => {
                btn.disabled = false;
                
                if (btn.classList.contains('warmup')) {
                    btn.innerHTML = '<div class="category-title">üèÉ‚Äç‚ôÇÔ∏è Warm-up</div><div class="category-desc">Quick MCQ practice questions</div>';
                } else if (btn.classList.contains('technical')) {
                    btn.innerHTML = '<div class="category-title">‚öôÔ∏è Technical</div><div class="category-desc">Hard skills & coding challenges</div>';
                } else if (btn.classList.contains('behavioral')) {
                    btn.innerHTML = '<div class="category-title">ü§ù Behavioral</div><div class="category-desc">Soft skills & situational questions</div>';
                } else if (btn.classList.contains('techno-behavioral')) {
                    btn.innerHTML = '<div class="category-title">üî¨ Techno-Behavioral</div><div class="category-desc">Mixed technical + behavioral scenarios</div>';
                } else if (btn.classList.contains('coding')) {
                    btn.innerHTML = '<div class="category-title">üíª Coding</div><div class="category-desc">Programming questions and Coding challenges</div>';
                } else if (btn.classList.contains('complete')) {
                    btn.innerHTML = '<div class="category-title">üéØ Complete Interview</div><div class="category-desc">Full 360¬∞ assessment - all categories combined</div>';
                }
            });
            
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const micBtn = document.getElementById('micBtn');
            if (messageInput) {
                messageInput.disabled = false;
                messageInput.value = '';
            }
            if (sendBtn) sendBtn.disabled = false;
            if (micBtn) micBtn.disabled = false;
            
            document.querySelector(".end-instruction").textContent = 
                "Type or say \"END\" to complete the interview and receive feedback via email.";
        }
		
        function setupInterviewUI(data) {
            document.getElementById('categorySelection').style.display = 'none';
            document.getElementById('chatInput').style.display = 'block';
            document.getElementById('backBtn').style.display = 'block';

            const typeDisplayNames = {
                'warmup': 'Interview Warm-up',
                'technical': 'Technical Interview', 
                'behavioral': 'Behavioral Interview',
                'techno-behavioral': 'Techno-Behavioral Interview',
                'coding': 'Coding Interview',
                'comprehensive': 'Complete Interview'
            };
            
            addMessage(`üë®‚Äçüíº <strong>${typeDisplayNames[selectedInterviewType]} Started</strong><br>`);
            
            if (data.question) {
                setTimeout(() => {
                    const messageElement = addMessage(data.question, false, true);
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.question;
                    const textToSpeak = tempDiv.textContent || tempDiv.innerText || '';
                    
                    if (textToSpeak.trim()) {
                        setTimeout(() => {
                         
                        }, 800);
                    }
                }, 1500);
            }
            
            console.log("‚úÖ Interview started successfully");

            startTimer();
            interviewStarted = true;
            
            setTimeout(() => {
                const messageInput = document.getElementById('messageInput');
                if (messageInput) {
                    messageInput.focus();
                }
            }, 2000);
        }
        
        async function sendMessage(forcedMessage = null, systemTriggered = false) {
            if (!interviewStarted) return;

            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = forcedMessage !== null ? forcedMessage : messageInput.value.trim();
            
            if (!message) return;

            if (!systemTriggered) {
                addMessage(message, true);
            }

            if (!systemTriggered) {
                messageInput.value = '';
                sendBtn.disabled = true;
            }

            showTypingIndicator();
            console.log("üì§ Sending message:", message.substring(0, 50) + "...");
            
            try {
                const payload = {
                    message: message,
                    sessionId: sessionId,
                    candidateEmail: candidateEmail,
                    interviewType: selectedInterviewType
                };
                console.log("üìß Including email in request:", candidateEmail);
                console.log("üéØ Including interview type:", selectedInterviewType);
       
                const response = await fetch(CHAT_URL, {
                    method: 'POST',
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log("üì• Chat response status:", response.status);
                hideTypingIndicator();
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.log("‚ùå Chat error:", errorText);
                    throw new Error(`Chat failed: ${response.status}`);
                }
                
                const responseText = await response.text();
                console.log("üìã Raw chat response length:", responseText.length);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.log("‚ùå JSON parse error:", parseError.message);
                    throw new Error('Invalid JSON response from AI interviewer');
                }

                if (Array.isArray(data) && data.length > 0) {
                    data = data[0];
                    console.log("üìã Using first array item");
                }

                if (data.response) {
                    const messageElement = addMessage(data.response, false, true);
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.response;
                    const textToSpeak = tempDiv.textContent || tempDiv.innerText || '';
                    
                    if (textToSpeak.trim()) {
                        setTimeout(() => {
                     
                        }, 500);
                    }
                    
                    console.log("‚úÖ Added AI response");
                } else if (data.output) {
                    const messageElement = addMessage(data.output, false, true);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.output;
                    const textToSpeak = tempDiv.textContent || tempDiv.innerText || '';
                    if (textToSpeak.trim()) {
                        setTimeout(() => {
                     
                        }, 500);
                    }
                    console.log("‚úÖ Added AI output");
                } else if (data.text) {
                    const messageElement = addMessage(data.text, false, true);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.text;
                    const textToSpeak = tempDiv.textContent || tempDiv.innerText || '';
                    if (textToSpeak.trim()) {
                        setTimeout(() => {
                  
                        }, 500);
                    }
                    console.log("‚úÖ Added AI text");
                } else if (typeof data === 'string') {
                    const messageElement = addMessage(data, false, true);
                    if (data.trim()) {
                        setTimeout(() => {
                     
                        }, 500);
                    }
                    console.log("‚úÖ Added string response");
                } else {
                    addMessage("I need a moment to process your response. Could you please elaborate on that?");
                    console.log("‚ö†Ô∏è No response field found in:", JSON.stringify(data).substring(0, 100));
                }

                if (data.response && data.response.includes("‚úÖ Thanks for completing")) {
                    const messageInput = document.getElementById('messageInput');
                    const sendBtn = document.getElementById('sendBtn');
                    const micBtn = document.getElementById('micBtn');
                    if (messageInput) messageInput.disabled = true;
                    if (sendBtn) sendBtn.disabled = true;
                    if (micBtn) micBtn.disabled = true;
                    document.querySelector(".end-instruction").textContent =
                        "Interview has ended. Check your email for feedback ‚úÖ";
                }
                
            } catch (error) {
                hideTypingIndicator();
                console.log("‚ùå Chat error:", error.message);
                addMessage('Sorry, there was a technical issue. Please try again.');
            } finally {
                sendBtn.disabled = false;
                const messageInput = document.getElementById('messageInput');
                if (messageInput && !messageInput.disabled) {
                    messageInput.focus();
                }
            }
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        async function toggleRecording() {
            if (!interviewStarted) return;
            
            if (!isRecording) {
                await startRecording();
            } else {
                await stopRecording();
            }
        }
        
        async function startRecording() {
            try {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    addMessage('‚ùå Speech recognition not supported in this browser. Please use Chrome.', false);
                    return;
                }
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const messageInput = document.getElementById('messageInput');
                    messageInput.value = transcript;
                    messageInput.focus();
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    addMessage('‚ùå Could not understand speech. Please try again.', false);
                };
                
                recognition.onend = () => {
                    isRecording = false;
                    const micBtn = document.getElementById('micBtn');
                    micBtn.textContent = 'üé§';
                    micBtn.classList.remove('recording');
                    const recordingStatus = document.getElementById('recordingStatus');
                    recordingStatus.classList.remove('active');
                };
                
                recognition.start();
                isRecording = true;
                
                const micBtn = document.getElementById('micBtn');
                const recordingStatus = document.getElementById('recordingStatus');
                micBtn.textContent = '‚èπÔ∏è';
                micBtn.classList.add('recording');
                recordingStatus.classList.add('active');
                
            } catch (error) {
                console.error('Error with speech recognition:', error);
                addMessage('‚ùå Could not access speech recognition.', false);
            }
        }
        
        function showFileStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `file-status ${type}`;
                statusEl.style.display = 'block';
            }
        }
        
        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
        
        const resumeFileInput = document.getElementById('resumeFile');
        if (resumeFileInput) {
            resumeFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.type === 'application/pdf') {
                        showFileStatus('resumeStatus', `‚úÖ ${file.name} selected (${Math.round(file.size/1024)} KB)`, 'success');
                        console.log("üìÑ File selected:", file.name, "(", file.size, "bytes)");
                    } else {
                        showFileStatus('resumeStatus', '‚ùå Please select a PDF file', 'error');
                        e.target.value = '';
                    }
                }
            });
        }
        
        const uploadSection = document.getElementById('uploadSection');
        
        if (uploadSection) {
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });
            
            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
            });
            
            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'application/pdf') {
                        const resumeFileInput = document.getElementById('resumeFile');
                        if (resumeFileInput) {
                            resumeFileInput.files = files;
                            showFileStatus('resumeStatus', `‚úÖ ${file.name} selected`, 'success');
                            console.log("üìÑ File dropped:", file.name);
                        }
                    } else {
                        showFileStatus('resumeStatus', '‚ùå Please drop a PDF file', 'error');
                    }
                }
            });
        }
        
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && !e.target.matches('input, textarea') && interviewStarted) {
                e.preventDefault();
                if (!isRecording) {
                    toggleRecording();
                }
            }
        });
        
        document.addEventListener('keyup', function(e) {
            if (e.code === 'Space' && !e.target.matches('input, textarea') && interviewStarted && isRecording) {
                e.preventDefault();
                toggleRecording();
            }
        });

        console.log("üîß Frontend initialized. API Base:", API_BASE);
    </script>
</body>
</html>
